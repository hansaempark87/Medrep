<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>MedRep Intelligence - AI-Powered Pharma Sales Intelligence</title>
<meta name="description" content="AI 기반 제약 영업 인텔리전스 플랫폼 — KOL 분석, P&T 전략, 경쟁사 인사이트"/>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Noto+Sans+KR:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css" rel="stylesheet"/>
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        primary: { 50:'#e8f0f8', 100:'#c5d9ed', 200:'#9ebfe0', 300:'#77a5d3', 400:'#5991c9', 500:'#3b7dbf', 600:'#2f6ba8', 700:'#1f5a91', 800:'#0F4C81', 900:'#0a3a64', 950:'#062848' },
        accent: { 50:'#fff7ed', 100:'#ffedd5', 200:'#fed7aa', 300:'#fdba74', 400:'#fb923c', 500:'#f97316', 600:'#ea580c', 700:'#c2410c', 800:'#9a3412', 900:'#7c2d12' },
        success: { 50:'#ecfdf5', 100:'#d1fae5', 500:'#10b981', 600:'#059669', 700:'#047857' },
        danger: { 50:'#fef2f2', 100:'#fee2e2', 500:'#ef4444', 600:'#dc2626' },
        surface: { 50:'#f8fafc', 100:'#f1f5f9', 200:'#e2e8f0', 300:'#cbd5e1' }
      },
      fontFamily: { sans: ['Inter','Noto Sans KR','system-ui','sans-serif'] }
    }
  }
}
</script>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Inter','Noto Sans KR',system-ui,sans-serif; background:#f0f4f8; }
::-webkit-scrollbar { width:6px; }
::-webkit-scrollbar-track { background:#f1f5f9; }
::-webkit-scrollbar-thumb { background:#94a3b8; border-radius:3px; }
@keyframes fadeInUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }
@keyframes pulse-glow { 0%,100% { box-shadow:0 0 0 0 rgba(15,76,129,0.2); } 50% { box-shadow:0 0 0 8px rgba(15,76,129,0); } }
@keyframes shimmer { 0% { background-position: -200px 0; } 100% { background-position: 200px 0; } }
.animate-fadeInUp { animation: fadeInUp 0.5s ease-out forwards; }
.pulse-glow { animation: pulse-glow 2s infinite; }
.stat-card:hover { transform:translateY(-4px); box-shadow:0 12px 40px rgba(15,76,129,0.15); }
.nav-item:hover { background:rgba(255,255,255,0.1); }
.nav-item.active { background:rgba(255,255,255,0.15); border-left:3px solid #60a5fa; }
.kol-card:hover { transform:translateY(-2px); box-shadow:0 8px 25px rgba(0,0,0,0.1); }
.strategy-item:hover { background:#f0f7ff; border-left-color:#0F4C81; }
@keyframes progressStep { from { width:0; } to { width:100%; } }
.progress-animate { animation: progressStep 20s linear forwards; }
.shimmer-bg { background: linear-gradient(90deg, #f0f0f0 25%, #e8e8e8 50%, #f0f0f0 75%); background-size: 400px 100%; animation: shimmer 1.5s infinite linear; }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef, useCallback } = React;

// ============================================================
// MOCK DATA
// ============================================================
const recentKOLs = [
  { name: "정심부 교수", hospital: "삼성서울병원 심장내과", date: "2024.01.11", tags: ["심부전","ARNI","디지털치료"], searchQuery: "삼성서울병원 심장내과 정심부 교수" },
  { name: "최소아 교수", hospital: "서울대어린이병원 소아과", date: "2024.01.10", tags: ["소아당뇨","인슐린펌프","CGM"], searchQuery: "서울대어린이병원 소아과 최소아 교수" },
  { name: "한피부 교수", hospital: "연세대 피부과", date: "2024.01.09", tags: ["아토피","JAK억제제","생물학적제제"], searchQuery: "연세대 세브란스 피부과 한피부 교수" },
  { name: "윤호흡 교수", hospital: "서울아산병원 호흡기내과", date: "2024.01.08", tags: ["COPD","삼중흡입제","생물학적제제"], searchQuery: "서울아산병원 호흡기내과 윤호흡 교수" }
];

const monthlyData = [
  { month:"1월", count:15 }, { month:"2월", count:18 }, { month:"3월", count:22 },
  { month:"4월", count:19 }, { month:"5월", count:25 }, { month:"6월", count:28 },
  { month:"7월", count:31 }, { month:"8월", count:27 }, { month:"9월", count:35 },
  { month:"10월", count:38 }, { month:"11월", count:42 }, { month:"12월", count:47 }
];

const upcomingSchedules = [
  { title: "삼성서울병원 P&T 위원회", date: "2024.01.15", dday: 3, type: "critical", desc: "신약 등재 심의 - 발표자료 최종 검토 필요" },
  { title: "서울대병원 약제부 미팅", date: "2024.01.18", dday: 6, type: "normal", desc: "분기별 약품 사용 현황 리뷰" },
  { title: "분당서울대 약사위원회", date: "2024.01.22", dday: 10, type: "normal", desc: "약가 협상 관련 사전 미팅" },
  { title: "KDA 동계학술대회", date: "2024.01.25", dday: 13, type: "conference", desc: "부스 운영 + 심포지엄 좌장 섭외 확인" }
];

const teamMembers = [
  { name: "김영업", role: "수도권 1팀", status: "active", kols: 12, target: 85 },
  { name: "이약품", role: "수도권 2팀", status: "active", kols: 9, target: 78 },
  { name: "박제약", role: "경인지역", status: "active", kols: 11, target: 92 },
  { name: "최마케", role: "충청지역", status: "inactive", kols: 7, target: 65 },
  { name: "정학술", role: "MSL", status: "active", kols: 15, target: 88 },
  { name: "한영업", role: "수도권 3팀", status: "active", kols: 10, target: 82 }
];

const ptDatabase = {
  hospitals: [
    {
      name: "삼성서울병원", committee: "약사위원회 (P&T)", nextMeeting: "2024.01.15", dday: 3, status: "준비중",
      members: [
        { name: "김약제 부장", role: "약제부장 (위원장)", influence: "최고", stance: "중립", note: "근거 중심 판단. 최신 메타분석 자료 준비 필수" },
        { name: "정내과 교수", role: "내과 대표", influence: "높음", stance: "우호적", note: "우리 제품 임상경험 긍정적. 사전 1:1 미팅 완료" },
        { name: "이외과 교수", role: "외과 대표", influence: "보통", stance: "중립", note: "관련 진료과 아니지만 비용 효과성에 관심" },
        { name: "박약사", role: "임상약사", influence: "높음", stance: "부정적", note: "경쟁사 제품 대비 약가 우려. 약물경제학 자료 별도 준비 필요" }
      ],
      strategy: [
        "김약제 부장에게 국내외 가이드라인 반영 현황 1페이지 요약 전달",
        "정내과 교수의 처방 경험 사례를 위원회 발표에 활용 (사전 동의 완료)",
        "박약사의 약가 우려에 대비한 약물경제학 분석 자료 (ICER 데이터) 준비",
        "위원회 2일 전 약제부에 최종 자료 패킷 전달 (관례)"
      ],
      documents: [
        { name: "제품 요약 자료 (PI Summary)", status: "완료", icon: "fa-file-medical" },
        { name: "임상시험 핵심 데이터", status: "완료", icon: "fa-chart-bar" },
        { name: "약물경제학 분석", status: "진행중", icon: "fa-calculator" },
        { name: "국내외 가이드라인 비교표", status: "완료", icon: "fa-globe" },
        { name: "경쟁제품 비교 자료", status: "검토필요", icon: "fa-balance-scale" }
      ]
    },
    {
      name: "서울아산병원", committee: "신약심의위원회", nextMeeting: "2024.02.05", dday: 24, status: "자료준비",
      members: [
        { name: "최약제 부장", role: "약제부장", influence: "최고", stance: "중립", note: "데이터 기반 의사결정. RCT + RWD 모두 중시" },
        { name: "이종양 교수", role: "종양내과 대표", influence: "높음", stance: "우호적", note: "임상시험 경험으로 제품 이해도 높음" }
      ],
      strategy: [
        "이종양 교수의 임상시험 경험을 활용한 리얼월드 데이터 제시",
        "아산병원 내 유사 약제 처방 현황 분석 자료 준비"
      ],
      documents: [
        { name: "제품 요약 자료", status: "진행중", icon: "fa-file-medical" },
        { name: "임상시험 데이터 패키지", status: "진행중", icon: "fa-chart-bar" }
      ]
    }
  ]
};

// ============================================================
// COMPONENTS
// ============================================================
function Sidebar({ currentPage, setCurrentPage, sidebarOpen, setSidebarOpen }) {
  const navItems = [
    { id:'dashboard', icon:'fa-chart-line', label:'대시보드', badge: null },
    { id:'kol', icon:'fa-user-doctor', label:'KOL 인텔리전스', badge: 'AI' },
    { id:'pnt', icon:'fa-hospital', label:'P&T 전략', badge: '2' },
    { id:'pricing', icon:'fa-credit-card', label:'구독 플랜', badge: null }
  ];
  return (
    <>
      {/* Mobile overlay */}
      {sidebarOpen && <div className="fixed inset-0 bg-black/50 z-40 lg:hidden" onClick={() => setSidebarOpen(false)} />}
      <div className={`fixed left-0 top-0 h-full w-64 bg-gradient-to-b from-primary-800 via-primary-900 to-primary-950 text-white flex flex-col z-50 shadow-2xl transition-transform duration-300 lg:translate-x-0 ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
        <div className="p-5 border-b border-primary-700/50">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 bg-gradient-to-br from-blue-400 to-cyan-300 rounded-xl flex items-center justify-center shadow-lg">
              <i className="fas fa-brain text-primary-900 text-lg"></i>
            </div>
            <div>
              <h1 className="text-lg font-bold tracking-tight">MedRep<span className="text-blue-300">AI</span></h1>
              <p className="text-[10px] text-blue-300/70 tracking-wider uppercase">Intelligence Platform</p>
            </div>
          </div>
        </div>
        <nav className="flex-1 p-3 space-y-1 mt-2">
          {navItems.map(item => (
            <button key={item.id} onClick={() => { setCurrentPage(item.id); setSidebarOpen(false); }}
              className={`nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left transition-all duration-200 ${
                currentPage === item.id ? 'active bg-white/15 text-white font-semibold shadow-lg shadow-primary-900/30' : 'text-blue-200/80 hover:text-white'
              }`}>
              <i className={`fas ${item.icon} w-5 text-center ${currentPage === item.id ? 'text-blue-300' : ''}`}></i>
              <span className="text-sm">{item.label}</span>
              {item.badge && (
                <span className={`ml-auto text-[10px] font-bold px-2 py-0.5 rounded-full ${
                  item.badge === 'AI' ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white' : 'bg-blue-500/30 text-blue-200'
                }`}>{item.badge}</span>
              )}
            </button>
          ))}
        </nav>
        <div className="p-4 border-t border-primary-700/50">
          <div className="flex items-center gap-3">
            <div className="w-9 h-9 rounded-full bg-gradient-to-br from-blue-400 to-cyan-300 flex items-center justify-center text-primary-900 font-bold text-sm">TL</div>
            <div className="flex-1 min-w-0">
              <p className="text-sm font-semibold truncate">사용자</p>
              <p className="text-[11px] text-blue-300/60">영업전략팀</p>
            </div>
            <div className="w-2 h-2 bg-green-400 rounded-full"></div>
          </div>
        </div>
      </div>
    </>
  );
}

function Header({ currentPage, setSidebarOpen }) {
  const titles = {
    dashboard: { title:'대시보드', sub:'팀 성과와 주요 지표를 한눈에 확인하세요' },
    kol: { title:'KOL 인텔리전스', sub:'OpenAI 기반 핵심 오피니언 리더 실시간 분석' },
    pnt: { title:'P&T 전략 플래너', sub:'병원 약사위원회 대응 전략 수립' },
    pricing: { title:'구독 플랜', sub:'팀 규모에 맞는 최적의 플랜을 선택하세요' }
  };
  const info = titles[currentPage] || titles.dashboard;
  return (
    <header className="bg-white/80 backdrop-blur-md border-b border-surface-200 px-4 lg:px-8 py-4 sticky top-0 z-30">
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-3">
          <button onClick={() => setSidebarOpen(true)} className="lg:hidden w-10 h-10 rounded-xl bg-surface-100 flex items-center justify-center text-gray-500 hover:bg-surface-200 transition-colors">
            <i className="fas fa-bars"></i>
          </button>
          <div>
            <h2 className="text-lg lg:text-xl font-bold text-gray-900">{info.title}</h2>
            <p className="text-xs lg:text-sm text-gray-500 mt-0.5">{info.sub}</p>
          </div>
        </div>
        <div className="flex items-center gap-3 lg:gap-4">
          <div className="relative">
            <button className="w-10 h-10 rounded-xl bg-surface-100 flex items-center justify-center text-gray-500 hover:bg-surface-200 transition-colors">
              <i className="fas fa-bell"></i>
            </button>
            <span className="absolute -top-1 -right-1 w-5 h-5 bg-danger-500 text-white text-[10px] font-bold rounded-full flex items-center justify-center">3</span>
          </div>
          <div className="text-right hidden sm:block">
            <p className="text-xs text-gray-400">Powered by</p>
            <p className="text-xs text-gray-600 font-semibold">OpenAI GPT</p>
          </div>
        </div>
      </div>
    </header>
  );
}

function StatCard({ icon, iconColor, bgColor, title, value, sub, subColor, delay, onClick }) {
  return (
    <div onClick={onClick} className={`stat-card bg-white rounded-2xl p-5 lg:p-6 shadow-sm border border-surface-200/60 transition-all duration-300 animate-fadeInUp ${onClick ? 'cursor-pointer' : ''}`} style={{ animationDelay:`${delay}ms` }}>
      <div className={`w-11 h-11 lg:w-12 lg:h-12 ${bgColor} rounded-xl flex items-center justify-center`}>
        <i className={`fas ${icon} ${iconColor} text-base lg:text-lg`}></i>
      </div>
      <div className="mt-3 lg:mt-4">
        <p className="text-xs lg:text-sm text-gray-500 font-medium">{title}</p>
        <p className="text-xl lg:text-2xl font-bold text-gray-900 mt-1">{value}</p>
        <p className={`text-[11px] lg:text-xs mt-1.5 lg:mt-2 ${subColor} font-medium flex items-center gap-1`}>{sub}</p>
      </div>
    </div>
  );
}

function PerformanceChart() {
  const chartRef = useRef(null);
  const chartInstance = useRef(null);
  useEffect(() => {
    if (chartInstance.current) chartInstance.current.destroy();
    const ctx = chartRef.current.getContext('2d');
    chartInstance.current = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: monthlyData.map(d => d.month),
        datasets: [{ label:'KOL 분석 건수', data: monthlyData.map(d => d.count),
          backgroundColor: monthlyData.map((d,i) => i === 11 ? '#0F4C81' : 'rgba(15,76,129,0.45)'),
          borderRadius: 6, borderSkipped: false, barPercentage: 0.7 }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false }, tooltip: { backgroundColor:'#1e293b', cornerRadius:8, padding:10, titleFont:{size:12}, bodyFont:{size:13}, callbacks: { label: ctx => ` 분석 건수: ${ctx.parsed.y}건` } } },
        scales: { y: { beginAtZero:true, grid:{ color:'rgba(0,0,0,0.04)' }, ticks:{ font:{ size:11 }, color:'#94a3b8' } }, x: { grid:{ display:false }, ticks:{ font:{ size:11 }, color:'#64748b' } } }
      }
    });
    return () => { if (chartInstance.current) chartInstance.current.destroy(); };
  }, []);
  return <canvas ref={chartRef}></canvas>;
}

// -- Dashboard --
function Dashboard({ onNavigateToKOL }) {
  return (
    <div className="space-y-5 lg:space-y-6">
      <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 lg:gap-5">
        <StatCard icon="fa-user-doctor" iconColor="text-primary-600" bgColor="bg-primary-50" title="이번 달 분석한 KOL" value="47명" sub={<><i className="fas fa-arrow-up text-[10px]"></i> 전월 대비 23% 증가</>} subColor="text-success-600" delay={0} />
        <StatCard icon="fa-users" iconColor="text-accent-600" bgColor="bg-accent-50" title="팀 활동 현황" value="12 / 15명" sub={<><i className="fas fa-circle text-[8px] text-green-400"></i> 활성 사용자 80%</>} subColor="text-gray-500" delay={100} />
        <StatCard icon="fa-calendar-check" iconColor="text-danger-500" bgColor="bg-danger-50" title="다가오는 일정" value="삼성서울병원 P&T" sub={<><span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-red-100 text-red-600 font-bold text-[11px] pulse-glow"><i className="fas fa-exclamation-circle text-[9px]"></i> D-3 긴급 준비 필요</span></>} subColor="text-danger-600" delay={200} />
      </div>
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-4 lg:gap-5">
        <div className="lg:col-span-2 bg-white rounded-2xl p-5 lg:p-6 shadow-sm border border-surface-200/60 animate-fadeInUp" style={{ animationDelay:'300ms' }}>
          <div className="flex items-center justify-between mb-4">
            <div><h3 className="font-bold text-gray-900 text-sm lg:text-base">2024년 팀 성과 현황</h3><p className="text-[11px] text-gray-400 mt-0.5">월별 KOL 분석 추이</p></div>
            <div className="flex items-center gap-2 text-[11px] text-gray-400"><span className="w-3 h-3 rounded bg-primary-800"></span> 이번 달 <span className="w-3 h-3 rounded bg-primary-400/50"></span> 이전</div>
          </div>
          <div style={{ height:'260px' }}><PerformanceChart /></div>
        </div>
        <div className="bg-white rounded-2xl p-5 lg:p-6 shadow-sm border border-surface-200/60 animate-fadeInUp" style={{ animationDelay:'400ms' }}>
          <h3 className="font-bold text-gray-900 mb-4 flex items-center gap-2 text-sm lg:text-base"><i className="fas fa-calendar-alt text-primary-500"></i> 다가오는 일정</h3>
          <div className="space-y-2.5">
            {upcomingSchedules.map((s, i) => (
              <div key={i} className={`p-3 rounded-xl border-l-4 ${s.type==='critical'?'border-red-500 bg-red-50/50':s.type==='conference'?'border-purple-500 bg-purple-50/50':'border-primary-300 bg-primary-50/30'}`}>
                <div className="flex items-center justify-between">
                  <span className="text-xs lg:text-sm font-semibold text-gray-800">{s.title}</span>
                  <span className={`text-[10px] font-bold px-2 py-0.5 rounded-full ${s.dday<=5?'bg-red-100 text-red-600':'bg-gray-100 text-gray-500'}`}>D-{s.dday}</span>
                </div>
                <p className="text-[10px] lg:text-[11px] text-gray-400 mt-1">{s.desc}</p>
              </div>
            ))}
          </div>
        </div>
      </div>
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-4 lg:gap-5">
        <div className="lg:col-span-2 bg-white rounded-2xl p-5 lg:p-6 shadow-sm border border-surface-200/60 animate-fadeInUp" style={{ animationDelay:'500ms' }}>
          <div className="flex items-center justify-between mb-4">
            <h3 className="font-bold text-gray-900 flex items-center gap-2 text-sm lg:text-base"><i className="fas fa-history text-primary-500"></i> 최근 분석한 KOL</h3>
            <button onClick={() => onNavigateToKOL('')} className="text-xs text-primary-600 hover:text-primary-800 font-medium transition-colors">
              전체보기 <i className="fas fa-chevron-right text-[10px] ml-0.5"></i>
            </button>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
            {recentKOLs.map((kol, i) => (
              <div key={i} onClick={() => onNavigateToKOL(kol.searchQuery)}
                className="kol-card p-4 rounded-xl border border-surface-200 hover:border-primary-200 transition-all duration-200 cursor-pointer group">
                <div className="flex items-start gap-3">
                  <div className="w-10 h-10 rounded-full bg-gradient-to-br from-primary-400 to-primary-600 flex items-center justify-center text-white text-sm font-bold flex-shrink-0">{kol.name.charAt(0)}</div>
                  <div className="flex-1 min-w-0">
                    <div className="flex items-center gap-2">
                      <p className="font-semibold text-gray-900 text-sm">{kol.name}</p>
                      <i className="fas fa-arrow-right text-[10px] text-primary-400 opacity-0 group-hover:opacity-100 transition-opacity"></i>
                    </div>
                    <p className="text-[11px] text-gray-400 truncate">{kol.hospital}</p>
                    <div className="flex flex-wrap gap-1 mt-2">{kol.tags.map((tag,j) => (<span key={j} className="text-[10px] px-2 py-0.5 rounded-full bg-primary-50 text-primary-600 font-medium">{tag}</span>))}</div>
                  </div>
                  <span className="text-[10px] text-gray-300 flex-shrink-0">{kol.date}</span>
                </div>
              </div>
            ))}
          </div>
        </div>
        <div className="bg-white rounded-2xl p-5 lg:p-6 shadow-sm border border-surface-200/60 animate-fadeInUp" style={{ animationDelay:'600ms' }}>
          <h3 className="font-bold text-gray-900 mb-4 flex items-center gap-2 text-sm lg:text-base"><i className="fas fa-users text-primary-500"></i> 팀원 현황</h3>
          <div className="space-y-3">
            {teamMembers.map((m, i) => (
              <div key={i} className="flex items-center gap-3 p-2 rounded-lg hover:bg-surface-50 transition-colors">
                <div className={`w-2 h-2 rounded-full ${m.status==='active'?'bg-green-400':'bg-gray-300'}`}></div>
                <div className="flex-1 min-w-0">
                  <div className="flex items-center justify-between"><span className="text-sm font-medium text-gray-800">{m.name}</span><span className="text-[10px] text-gray-400">KOL {m.kols}건</span></div>
                  <div className="flex items-center gap-2 mt-1">
                    <div className="flex-1 h-1.5 bg-surface-100 rounded-full overflow-hidden"><div className={`h-full rounded-full transition-all duration-700 ${m.target>=85?'bg-green-400':m.target>=70?'bg-blue-400':'bg-orange-400'}`} style={{ width:`${m.target}%` }}></div></div>
                    <span className="text-[10px] text-gray-400 w-8 text-right">{m.target}%</span>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  );
}

// ============================================================
// KOL INTELLIGENCE - OpenAI API 실시간 연동
// ============================================================
function KOLIntelligence({ initialQuery }) {
  const [searchQuery, setSearchQuery] = useState(initialQuery || '');
  const [selectedKOL, setSelectedKOL] = useState(null);
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [showResult, setShowResult] = useState(false);
  const [activeTab, setActiveTab] = useState('trends');
  const [error, setError] = useState(null);
  const [loadingSteps, setLoadingSteps] = useState([]);
  const hasAutoSearched = useRef(false);

  // Auto-search when navigated from dashboard with a query
  useEffect(() => {
    if (initialQuery && initialQuery.trim().length >= 2 && !hasAutoSearched.current) {
      hasAutoSearched.current = true;
      handleSearch(initialQuery);
    }
  }, [initialQuery]);

  const handleSearch = async (query) => {
    const q = (query || searchQuery).trim();
    if (!q || q.length < 2) return;

    setSearchQuery(q);
    setIsAnalyzing(true);
    setShowResult(false);
    setError(null);
    setActiveTab('trends');
    setLoadingSteps([]);

    const steps = [
      { text: 'OpenAI에 KOL 분석 요청 전송 중...', delay: 0 },
      { text: 'PubMed 논문 데이터 기반 연구 트렌드 분석...', delay: 2000 },
      { text: '학회 발표 이력 및 처방 패턴 분석 중...', delay: 5000 },
      { text: '경쟁사 포지셔닝 및 접근 전략 생성 중...', delay: 9000 },
      { text: '맞춤형 인텔리전스 리포트 생성 중...', delay: 14000 }
    ];
    steps.forEach((step) => {
      setTimeout(() => setLoadingSteps(prev => [...prev, step.text]), step.delay);
    });

    try {
      const response = await fetch('/api/kol/analyze', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query: q })
      });

      if (!response.ok) {
        const errData = await response.json().catch(() => ({}));
        throw new Error(errData.error || `분석 실패 (${response.status})`);
      }

      const result = await response.json();
      if (result.success && result.data) {
        const d = result.data;
        setSelectedKOL({
          ...d,
          photo: d.name ? d.name.replace(/\s*교수.*/, '').replace(/\(.*\)/, '').trim().slice(-1) || '?' : '?',
          strategy: d.strategy || { approach:'', tips:[], competitors:[] },
          recentActivities: d.recentActivities || []
        });
        setShowResult(true);

        // Save to history (fire and forget)
        fetch('/api/kol/history', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query: q, name: d.name, hospital: d.hospital, specialty: d.specialty, result_json: d })
        }).catch(() => {});
      } else {
        throw new Error('분석 결과를 받지 못했습니다');
      }
    } catch (err) {
      setError(err.message);
    } finally {
      setIsAnalyzing(false);
    }
  };

  const quickSearches = [
    { label: "서울대 김내분", query: "서울대학교병원 내분비내과 김내분 교수" },
    { label: "세브란스 박순환", query: "세브란스병원 순환기내과 박순환 교수" },
    { label: "아산병원 이종양", query: "서울아산병원 종양내과 이종양 교수" }
  ];

  return (
    <div className="space-y-5 lg:space-y-6">
      {/* Search Section */}
      <div className="bg-white rounded-2xl p-5 lg:p-8 shadow-sm border border-surface-200/60 animate-fadeInUp">
        <div className="text-center mb-5 lg:mb-6">
          <div className="inline-flex items-center gap-2 px-3 py-1 bg-gradient-to-r from-purple-500/10 to-pink-500/10 rounded-full mb-3">
            <i className="fas fa-wand-magic-sparkles text-purple-500 text-xs"></i>
            <span className="text-xs font-semibold text-purple-600">Powered by OpenAI GPT</span>
          </div>
          <h2 className="text-xl lg:text-2xl font-bold text-gray-900">KOL 인텔리전스 분석</h2>
          <p className="text-xs lg:text-sm text-gray-400 mt-1">교수님 이름이나 소속을 입력하세요 — AI가 실시간 분석합니다</p>
        </div>
        <div className="max-w-2xl mx-auto">
          <div className="relative">
            <i className="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-300"></i>
            <input type="text" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)}
              onKeyDown={(e) => e.key === 'Enter' && !isAnalyzing && handleSearch()}
              placeholder="교수님 이름과 소속을 입력하세요"
              disabled={isAnalyzing}
              className="w-full pl-12 pr-28 lg:pr-32 py-3.5 lg:py-4 rounded-2xl border-2 border-surface-200 focus:border-primary-400 focus:ring-4 focus:ring-primary-100 outline-none text-sm transition-all duration-200 disabled:opacity-50" />
            <button onClick={() => handleSearch()} disabled={isAnalyzing}
              className="absolute right-2 top-1/2 -translate-y-1/2 px-4 lg:px-6 py-2 lg:py-2.5 bg-gradient-to-r from-primary-800 to-primary-600 text-white rounded-xl text-xs lg:text-sm font-semibold hover:shadow-lg hover:shadow-primary-800/25 transition-all duration-200 disabled:opacity-50">
              {isAnalyzing ? <><i className="fas fa-spinner fa-spin mr-1.5"></i> 분석중</> : <><i className="fas fa-brain mr-1.5"></i> AI 분석</>}
            </button>
          </div>
          <div className="flex items-center gap-2 mt-4 justify-center flex-wrap">
            <span className="text-xs text-gray-400">빠른 검색:</span>
            {quickSearches.map((q, i) => (
              <button key={i} onClick={() => { setSearchQuery(q.query); handleSearch(q.query); }} disabled={isAnalyzing}
                className="text-xs px-3 py-1.5 rounded-full border border-primary-200 text-primary-600 hover:bg-primary-50 hover:border-primary-300 transition-all duration-200 font-medium disabled:opacity-50">
                <i className="fas fa-bolt text-[9px] mr-1 text-primary-400"></i>
                {q.label}
              </button>
            ))}
          </div>
        </div>
      </div>

      {/* Loading State */}
      {isAnalyzing && (
        <div className="bg-white rounded-2xl p-8 lg:p-10 shadow-sm border border-surface-200/60 animate-fadeInUp">
          <div className="max-w-md mx-auto">
            <div className="flex items-center justify-center gap-1.5 mb-5">
              <div className="w-2.5 h-2.5 rounded-full bg-primary-500 animate-bounce" style={{animationDelay:'0ms'}}></div>
              <div className="w-2.5 h-2.5 rounded-full bg-primary-400 animate-bounce" style={{animationDelay:'150ms'}}></div>
              <div className="w-2.5 h-2.5 rounded-full bg-primary-300 animate-bounce" style={{animationDelay:'300ms'}}></div>
            </div>
            <h3 className="text-lg font-bold text-gray-800 text-center mb-1">AI가 분석 중입니다</h3>
            <p className="text-xs text-gray-400 text-center mb-6">OpenAI GPT가 제약 영업 전문가 관점으로 분석하고 있습니다</p>
            <div className="w-full h-1.5 bg-surface-100 rounded-full overflow-hidden mb-5">
              <div className="h-full bg-gradient-to-r from-primary-500 to-blue-400 rounded-full progress-animate"></div>
            </div>
            <div className="space-y-2">
              {loadingSteps.map((step, i) => (
                <div key={i} className="flex items-center gap-2 text-sm animate-fadeInUp">
                  {i < loadingSteps.length - 1
                    ? <i className="fas fa-check-circle text-green-400 w-4"></i>
                    : <i className="fas fa-spinner fa-spin text-primary-500 w-4"></i>
                  }
                  <span className={i < loadingSteps.length - 1 ? 'text-gray-400 line-through' : 'text-primary-600 font-medium'}>{step}</span>
                </div>
              ))}
            </div>
          </div>
        </div>
      )}

      {/* Error State */}
      {error && !isAnalyzing && (
        <div className="bg-red-50 rounded-2xl p-5 lg:p-6 border border-red-200 animate-fadeInUp">
          <div className="flex items-center gap-3 flex-wrap">
            <div className="w-10 h-10 rounded-xl bg-red-100 flex items-center justify-center"><i className="fas fa-exclamation-triangle text-red-500"></i></div>
            <div className="flex-1 min-w-0">
              <h4 className="font-bold text-red-800 text-sm">분석 중 오류가 발생했습니다</h4>
              <p className="text-xs lg:text-sm text-red-600 mt-0.5">{error}</p>
            </div>
            <button onClick={() => handleSearch()} className="px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-medium hover:bg-red-700 transition-colors">재시도</button>
          </div>
        </div>
      )}

      {/* Results */}
      {showResult && selectedKOL && (
        <div className="space-y-4 lg:space-y-5 animate-fadeInUp">
          {/* Profile Header */}
          <div className="bg-white rounded-2xl overflow-hidden shadow-sm border border-surface-200/60">
            <div className="h-20 lg:h-24 bg-gradient-to-r from-primary-800 via-primary-700 to-primary-600 relative overflow-hidden">
              <div className="absolute inset-0 opacity-10"><div className="absolute top-4 left-10 w-32 h-32 border border-white/30 rounded-full"></div><div className="absolute -bottom-8 right-20 w-48 h-48 border border-white/20 rounded-full"></div></div>
              <div className="absolute top-3 right-4 flex items-center gap-1.5 px-3 py-1 bg-white/20 backdrop-blur-sm rounded-full">
                <i className="fas fa-bolt text-yellow-300 text-[10px]"></i>
                <span className="text-[10px] text-white font-medium">AI Generated</span>
              </div>
            </div>
            <div className="px-5 lg:px-8 pb-5 lg:pb-6 -mt-8 lg:-mt-10 relative">
              <div className="flex items-end gap-4 lg:gap-5 flex-wrap">
                <div className="w-16 h-16 lg:w-20 lg:h-20 rounded-2xl bg-gradient-to-br from-blue-400 to-cyan-300 flex items-center justify-center text-primary-900 text-xl lg:text-2xl font-bold border-4 border-white shadow-lg">
                  {selectedKOL.photo}
                </div>
                <div className="flex-1 pb-1 min-w-0">
                  <div className="flex items-center gap-2 lg:gap-3 flex-wrap">
                    <h2 className="text-lg lg:text-xl font-bold text-gray-900">{selectedKOL.name}</h2>
                    <span className="text-[10px] px-2 py-0.5 rounded-full bg-green-100 text-green-600 font-bold">Active KOL</span>
                  </div>
                  <p className="text-xs lg:text-sm text-gray-500 mt-0.5">{selectedKOL.hospital} {selectedKOL.position ? `| ${selectedKOL.position}` : ''}</p>
                </div>
                <div className="flex gap-3 lg:gap-4 pb-1">
                  {[{v:selectedKOL.publications,l:'논문 수'},{v:selectedKOL.hIndex,l:'H-Index'},{v:selectedKOL.clinicalTrials,l:'임상시험'}].map((s,i) => (
                    <div key={i} className="text-center"><p className="text-xl lg:text-2xl font-bold text-primary-800">{s.v || '-'}</p><p className="text-[10px] text-gray-400">{s.l}</p></div>
                  ))}
                </div>
              </div>
              <div className="grid grid-cols-3 gap-3 lg:gap-4 mt-4 lg:mt-5">
                {/* KOL Tier */}
                <div className="bg-surface-50 rounded-xl p-2.5 lg:p-3">
                  <div className="flex items-center justify-between mb-1.5 lg:mb-2"><span className="text-[10px] lg:text-xs text-gray-500">KOL Tier</span></div>
                  {(() => {
                    const inf = selectedKOL.influence || 0;
                    const tier = inf >= 85 ? { label:'Tier A', desc:'Global / National KOL', color:'bg-purple-600', textColor:'text-purple-600', bgColor:'bg-purple-50' } : inf >= 65 ? { label:'Tier B', desc:'Regional KOL', color:'bg-blue-500', textColor:'text-blue-600', bgColor:'bg-blue-50' } : inf >= 40 ? { label:'Tier C', desc:'Local KOL', color:'bg-teal-500', textColor:'text-teal-600', bgColor:'bg-teal-50' } : { label:'Tier D', desc:'Emerging Expert', color:'bg-gray-400', textColor:'text-gray-500', bgColor:'bg-gray-50' };
                    return (<div className="text-center"><span className={`inline-block text-sm lg:text-base font-black ${tier.textColor}`}>{tier.label}</span><p className="text-[9px] lg:text-[10px] text-gray-400 mt-0.5">{tier.desc}</p></div>);
                  })()}
                </div>
                {/* Persona */}
                <div className="bg-surface-50 rounded-xl p-2.5 lg:p-3">
                  <div className="flex items-center justify-between mb-1.5 lg:mb-2"><span className="text-[10px] lg:text-xs text-gray-500">Persona</span></div>
                  {(() => {
                    const persona = selectedKOL.persona || (selectedKOL.influence >= 80 ? 'Champion' : selectedKOL.influence >= 60 ? 'Advocate' : selectedKOL.influence >= 40 ? 'Supporter' : 'Neutral');
                    const map = { 'Champion':{ icon:'fa-crown', color:'text-yellow-600', bg:'bg-yellow-50' }, 'Advocate':{ icon:'fa-bullhorn', color:'text-blue-600', bg:'bg-blue-50' }, 'Supporter':{ icon:'fa-thumbs-up', color:'text-green-600', bg:'bg-green-50' }, 'Neutral':{ icon:'fa-minus-circle', color:'text-gray-500', bg:'bg-gray-50' }, 'Non-Adopter':{ icon:'fa-ban', color:'text-red-500', bg:'bg-red-50' } };
                    const p = map[persona] || map['Neutral'];
                    return (<div className="text-center"><i className={`fas ${p.icon} ${p.color} text-sm lg:text-base`}></i><p className={`text-xs lg:text-sm font-bold ${p.color} mt-0.5`}>{persona}</p></div>);
                  })()}
                </div>
                {/* Prescribing Pattern */}
                <div className="bg-surface-50 rounded-xl p-2.5 lg:p-3">
                  <div className="flex items-center justify-between mb-1.5 lg:mb-2"><span className="text-[10px] lg:text-xs text-gray-500">처방 패턴</span></div>
                  {(() => {
                    const pp = selectedKOL.prescriptionPower || 0;
                    const pattern = pp >= 75 ? { label:'High Adopter', color:'text-green-600', icon:'fa-arrow-trend-up' } : pp >= 45 ? { label:'Moderate', color:'text-blue-600', icon:'fa-arrows-left-right' } : { label:'Conservative', color:'text-orange-600', icon:'fa-shield-halved' };
                    return (<div className="text-center"><i className={`fas ${pattern.icon} ${pattern.color} text-sm lg:text-base`}></i><p className={`text-xs lg:text-sm font-bold ${pattern.color} mt-0.5`}>{pattern.label}</p></div>);
                  })()}
                </div>
              </div>
            </div>
          </div>

          {/* Tabs */}
          <div className="flex gap-1 bg-white rounded-2xl p-1.5 shadow-sm border border-surface-200/60 overflow-x-auto">
            {[{id:'trends',icon:'fa-chart-line',label:'연구 동향'},{id:'strategy',icon:'fa-chess',label:'접근 전략'},{id:'competitors',icon:'fa-shield-halved',label:'경쟁사 현황'},{id:'activities',icon:'fa-clock-rotate-left',label:'최근 활동'}].map(tab => (
              <button key={tab.id} onClick={() => setActiveTab(tab.id)}
                className={`flex-1 flex items-center justify-center gap-1.5 lg:gap-2 py-2.5 lg:py-3 rounded-xl text-xs lg:text-sm font-medium transition-all duration-200 whitespace-nowrap ${
                  activeTab===tab.id ? 'bg-primary-800 text-white shadow-lg shadow-primary-800/20' : 'text-gray-500 hover:bg-surface-50'
                }`}><i className={`fas ${tab.icon} text-[10px] lg:text-xs`}></i> {tab.label}</button>
            ))}
          </div>

          {/* Tab Content: Trends */}
          {activeTab === 'trends' && selectedKOL.trends && (
            <div className="grid gap-3 lg:gap-4 animate-fadeInUp">
              {selectedKOL.trends.map((t, i) => (
                <div key={i} className="bg-white rounded-2xl p-5 lg:p-6 shadow-sm border border-surface-200/60 border-l-4 border-l-primary-500 hover:shadow-md transition-all duration-200">
                  <div className="flex items-start gap-3 lg:gap-4">
                    <div className="w-9 h-9 lg:w-10 lg:h-10 rounded-xl bg-primary-50 flex items-center justify-center flex-shrink-0"><i className="fas fa-microscope text-primary-600"></i></div>
                    <div><h4 className="font-bold text-gray-900 text-sm lg:text-base flex items-center gap-2 flex-wrap">{t.keyword}<span className="text-[10px] px-2 py-0.5 rounded-full bg-blue-50 text-blue-500 font-medium">Hot Topic</span></h4>
                    <p className="text-xs lg:text-sm text-gray-600 mt-1.5 lg:mt-2 leading-relaxed">{t.desc}</p></div>
                  </div>
                </div>
              ))}
            </div>
          )}

          {/* Tab Content: Strategy */}
          {activeTab === 'strategy' && selectedKOL.strategy && (
            <div className="space-y-3 lg:space-y-4 animate-fadeInUp">
              {selectedKOL.strategy.approach && (
                <div className="bg-gradient-to-r from-primary-50 to-blue-50 rounded-2xl p-4 lg:p-5 border border-primary-100">
                  <div className="flex items-center gap-2 mb-1"><i className="fas fa-bullseye text-primary-600"></i><span className="text-xs lg:text-sm font-bold text-primary-800">추천 접근 전략</span></div>
                  <p className="text-xs lg:text-sm text-primary-700 font-medium">{selectedKOL.strategy.approach}</p>
                </div>
              )}
              {(selectedKOL.strategy.tips || []).map((tip, i) => (
                <div key={i} className="strategy-item bg-white rounded-2xl p-4 lg:p-5 shadow-sm border border-surface-200/60 border-l-4 border-l-transparent hover:border-l-primary-500 transition-all duration-200">
                  <div className="flex items-start gap-3 lg:gap-4">
                    <div className={`w-9 h-9 lg:w-10 lg:h-10 rounded-xl flex items-center justify-center flex-shrink-0 ${
                      tip.icon==='fa-lightbulb'?'bg-yellow-50 text-yellow-600':tip.icon==='fa-clock'?'bg-blue-50 text-blue-600':tip.icon==='fa-exclamation-triangle'?'bg-red-50 text-red-500':'bg-green-50 text-green-600'
                    }`}><i className={`fas ${tip.icon || 'fa-check'}`}></i></div>
                    <div><h4 className="font-bold text-gray-900 text-sm">{tip.title}</h4><p className="text-xs lg:text-sm text-gray-600 mt-1 lg:mt-1.5 leading-relaxed">{tip.text}</p></div>
                  </div>
                </div>
              ))}
            </div>
          )}

          {/* Tab Content: Competitors */}
          {activeTab === 'competitors' && selectedKOL.strategy?.competitors && (
            <div className="bg-white rounded-2xl p-5 lg:p-6 shadow-sm border border-surface-200/60 animate-fadeInUp">
              <h3 className="font-bold text-gray-900 mb-4 flex items-center gap-2 text-sm lg:text-base"><i className="fas fa-shield-halved text-primary-500"></i> 경쟁사 포지셔닝 현황</h3>
              <div className="space-y-3">
                {selectedKOL.strategy.competitors.map((c, i) => (
                  <div key={i} className="flex items-center gap-3 lg:gap-4 p-3 lg:p-4 rounded-xl border border-surface-200 hover:border-primary-200 transition-all">
                    <div className={`w-3 h-3 rounded-full flex-shrink-0 ${c.threat==='high'?'bg-red-500':c.threat==='medium'?'bg-yellow-500':'bg-green-500'}`}></div>
                    <div className="flex-1 min-w-0">
                      <div className="flex items-center gap-2 flex-wrap"><span className="font-semibold text-gray-800 text-xs lg:text-sm">{c.company}</span><span className="text-[10px] lg:text-xs px-2 py-0.5 rounded bg-surface-100 text-gray-500">{c.product}</span></div>
                      <p className="text-[10px] lg:text-xs text-gray-400 mt-0.5">{c.status}</p>
                    </div>
                    <span className={`text-[10px] font-bold px-2 lg:px-2.5 py-0.5 lg:py-1 rounded-full flex-shrink-0 ${c.threat==='high'?'bg-red-100 text-red-600':c.threat==='medium'?'bg-yellow-100 text-yellow-700':'bg-green-100 text-green-600'}`}>
                      {c.threat==='high'?'위협 높음':c.threat==='medium'?'주의 필요':'위협 낮음'}
                    </span>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Tab Content: Activities */}
          {activeTab === 'activities' && selectedKOL.recentActivities && (
            <div className="bg-white rounded-2xl p-5 lg:p-6 shadow-sm border border-surface-200/60 animate-fadeInUp">
              <h3 className="font-bold text-gray-900 mb-4 lg:mb-5 flex items-center gap-2 text-sm lg:text-base"><i className="fas fa-clock-rotate-left text-primary-500"></i> 최근 활동 타임라인</h3>
              <div className="relative pl-7 lg:pl-8">
                <div className="absolute left-2.5 lg:left-3 top-2 bottom-2 w-0.5 bg-surface-200"></div>
                {selectedKOL.recentActivities.map((a, i) => (
                  <div key={i} className="relative mb-5 lg:mb-6 last:mb-0">
                    <div className={`absolute -left-[18px] lg:-left-5 w-3.5 h-3.5 lg:w-4 lg:h-4 rounded-full border-2 border-white shadow ${
                      a.type==='학회발표'?'bg-blue-500':a.type==='논문발표'?'bg-purple-500':a.type==='임상시험'?'bg-green-500':a.type==='자문위원'?'bg-orange-500':'bg-gray-400'
                    }`}></div>
                    <div className="ml-3 lg:ml-4">
                      <div className="flex items-center gap-2 mb-1">
                        <span className="text-[10px] lg:text-xs text-gray-400">{a.date}</span>
                        <span className={`text-[10px] px-2 py-0.5 rounded-full font-medium ${
                          a.type==='학회발표'?'bg-blue-50 text-blue-600':a.type==='논문발표'?'bg-purple-50 text-purple-600':a.type==='임상시험'?'bg-green-50 text-green-600':'bg-orange-50 text-orange-600'
                        }`}>{a.type}</span>
                      </div>
                      <p className="text-xs lg:text-sm text-gray-700 leading-relaxed">{a.detail}</p>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      )}

      {/* Empty State when no search yet */}
      {!isAnalyzing && !showResult && !error && (
        <div className="bg-white rounded-2xl p-8 lg:p-12 shadow-sm border border-surface-200/60 text-center animate-fadeInUp">
          <div className="w-20 h-20 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-primary-50 to-blue-50 flex items-center justify-center">
            <i className="fas fa-user-doctor text-3xl text-primary-300"></i>
          </div>
          <h3 className="text-lg font-bold text-gray-800">KOL을 검색해보세요</h3>
          <p className="text-sm text-gray-400 mt-2 max-w-md mx-auto">교수님 이름, 병원명, 진료과 등을 입력하면<br/>AI가 실시간으로 분석하여 영업 인텔리전스를 제공합니다</p>
          <div className="flex items-center justify-center gap-4 mt-6 text-xs text-gray-400">
            <span className="flex items-center gap-1.5"><i className="fas fa-chart-line text-primary-400"></i> 연구 동향</span>
            <span className="flex items-center gap-1.5"><i className="fas fa-chess text-primary-400"></i> 접근 전략</span>
            <span className="flex items-center gap-1.5"><i className="fas fa-shield-halved text-primary-400"></i> 경쟁사 분석</span>
          </div>
        </div>
      )}
    </div>
  );
}

// -- P&T Strategy --
function PnTStrategy() {
  const [selectedHospital, setSelectedHospital] = useState(0);
  const hospital = ptDatabase.hospitals[selectedHospital];
  return (
    <div className="space-y-5 lg:space-y-6">
      <div className="grid grid-cols-1 md:grid-cols-2 gap-3 lg:gap-4 animate-fadeInUp">
        {ptDatabase.hospitals.map((h, i) => (
          <button key={i} onClick={() => setSelectedHospital(i)}
            className={`p-4 lg:p-5 rounded-2xl border-2 text-left transition-all duration-200 ${selectedHospital===i?'border-primary-500 bg-primary-50/50 shadow-lg shadow-primary-100':'border-surface-200 bg-white hover:border-primary-200'}`}>
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className={`w-11 h-11 lg:w-12 lg:h-12 rounded-xl flex items-center justify-center ${selectedHospital===i?'bg-primary-800 text-white':'bg-surface-100 text-gray-400'}`}><i className="fas fa-hospital text-lg"></i></div>
                <div><h3 className="font-bold text-gray-900 text-sm lg:text-base">{h.name}</h3><p className="text-[10px] lg:text-xs text-gray-400">{h.committee}</p></div>
              </div>
              <div className="text-right"><span className={`text-sm font-bold ${h.dday<=7?'text-red-500':'text-gray-500'}`}>D-{h.dday}</span><p className="text-[10px] text-gray-400">{h.nextMeeting}</p></div>
            </div>
          </button>
        ))}
      </div>
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-4 lg:gap-5">
        <div className="lg:col-span-2 bg-white rounded-2xl p-5 lg:p-6 shadow-sm border border-surface-200/60 animate-fadeInUp" style={{animationDelay:'100ms'}}>
          <h3 className="font-bold text-gray-900 mb-4 lg:mb-5 flex items-center gap-2 text-sm lg:text-base"><i className="fas fa-user-group text-primary-500"></i> 위원회 구성원 분석</h3>
          <div className="space-y-3 lg:space-y-4">
            {hospital.members.map((m, i) => (
              <div key={i} className="p-3 lg:p-4 rounded-xl border border-surface-200 hover:border-primary-200 hover:shadow-sm transition-all duration-200">
                <div className="flex items-start gap-3 lg:gap-4">
                  <div className="w-9 h-9 lg:w-10 lg:h-10 rounded-full bg-gradient-to-br from-primary-400 to-primary-600 flex items-center justify-center text-white text-xs lg:text-sm font-bold flex-shrink-0">{m.name.charAt(0)}</div>
                  <div className="flex-1 min-w-0">
                    <div className="flex items-center gap-1.5 lg:gap-2 flex-wrap">
                      <span className="font-semibold text-gray-800 text-xs lg:text-sm">{m.name}</span>
                      <span className="text-[10px] px-1.5 lg:px-2 py-0.5 rounded bg-surface-100 text-gray-500">{m.role}</span>
                      <span className={`text-[10px] px-1.5 lg:px-2 py-0.5 rounded-full font-medium ${m.stance==='우호적'?'bg-green-100 text-green-600':m.stance==='부정적'?'bg-red-100 text-red-600':'bg-gray-100 text-gray-500'}`}>{m.stance}</span>
                      <span className={`text-[10px] px-1.5 lg:px-2 py-0.5 rounded-full font-medium ${m.influence==='최고'?'bg-purple-100 text-purple-600':m.influence==='높음'?'bg-blue-100 text-blue-600':'bg-gray-100 text-gray-400'}`}>영향력: {m.influence}</span>
                    </div>
                    <p className="text-[10px] lg:text-xs text-gray-500 mt-1.5 lg:mt-2 leading-relaxed"><i className="fas fa-lightbulb text-yellow-500 mr-1"></i>{m.note}</p>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
        <div className="space-y-4 lg:space-y-5">
          <div className="bg-white rounded-2xl p-5 lg:p-6 shadow-sm border border-surface-200/60 animate-fadeInUp" style={{animationDelay:'200ms'}}>
            <h3 className="font-bold text-gray-900 mb-3 lg:mb-4 flex items-center gap-2 text-sm lg:text-base"><i className="fas fa-folder-open text-primary-500"></i> 준비 서류</h3>
            <div className="space-y-2 lg:space-y-2.5">
              {hospital.documents.map((d, i) => (
                <div key={i} className="flex items-center gap-2.5 lg:gap-3 p-2.5 lg:p-3 rounded-xl border border-surface-200 hover:bg-surface-50 transition-all">
                  <i className={`fas ${d.icon} text-primary-400 text-sm`}></i>
                  <span className="flex-1 text-xs lg:text-sm text-gray-700">{d.name}</span>
                  <span className={`text-[10px] px-1.5 lg:px-2 py-0.5 rounded-full font-medium ${d.status==='완료'?'bg-green-100 text-green-600':d.status==='진행중'?'bg-blue-100 text-blue-600':'bg-orange-100 text-orange-600'}`}>{d.status}</span>
                </div>
              ))}
            </div>
          </div>
          <div className={`rounded-2xl p-5 lg:p-6 text-center animate-fadeInUp ${hospital.dday<=7?'bg-gradient-to-br from-red-500 to-red-600 text-white':'bg-gradient-to-br from-primary-700 to-primary-800 text-white'}`} style={{animationDelay:'300ms'}}>
            <p className="text-xs lg:text-sm font-medium opacity-80">회의까지 남은 기간</p>
            <p className="text-4xl lg:text-5xl font-black mt-2">D-{hospital.dday}</p>
            <p className="text-xs lg:text-sm mt-2 opacity-80">{hospital.nextMeeting}</p>
            {hospital.dday<=7 && <div className="mt-3 flex items-center justify-center gap-1 text-xs"><i className="fas fa-exclamation-triangle"></i><span className="font-semibold">긴급 준비 필요</span></div>}
          </div>
        </div>
      </div>
      <div className="bg-white rounded-2xl p-5 lg:p-6 shadow-sm border border-surface-200/60 animate-fadeInUp" style={{animationDelay:'400ms'}}>
        <h3 className="font-bold text-gray-900 mb-4 lg:mb-5 flex items-center gap-2 text-sm lg:text-base"><i className="fas fa-list-check text-primary-500"></i> AI 추천 액션 플랜</h3>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
          {hospital.strategy.map((s, i) => (
            <div key={i} className="flex items-start gap-3 p-3 lg:p-4 rounded-xl bg-surface-50 border border-surface-200 hover:border-primary-200 transition-all">
              <div className="w-6 h-6 lg:w-7 lg:h-7 rounded-lg bg-primary-800 text-white flex items-center justify-center text-[10px] lg:text-xs font-bold flex-shrink-0">{i+1}</div>
              <p className="text-xs lg:text-sm text-gray-700 leading-relaxed">{s}</p>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}

// -- Pricing Page --
function PricingPage() {
  const plans = [
    { name:'Starter', price:'49,000', period:'/월', desc:'소규모 팀을 위한 기본 플랜', features:['월 50회 KOL AI 분석','팀원 3명','P&T 전략 플래너','기본 대시보드','이메일 지원'], highlight:false, cta:'무료 체험 시작' },
    { name:'Professional', price:'149,000', period:'/월', desc:'영업팀을 위한 추천 플랜', features:['월 500회 KOL AI 분석','팀원 15명','P&T 전략 플래너 (무제한)','고급 대시보드 + 리포트','PubMed 실시간 연동','경쟁사 인텔리전스','우선 지원 + 전담 CSM'], highlight:true, cta:'14일 무료 체험' },
    { name:'Enterprise', price:'문의', period:'', desc:'대형 제약사 맞춤 플랜', features:['무제한 KOL AI 분석','무제한 팀원','맞춤 AI 모델 학습','SSO / SAML 인증','온프레미스 배포 가능','전용 API 제공','SLA 99.9% 보장'], highlight:false, cta:'영업팀 문의' }
  ];
  return (
    <div className="space-y-6 lg:space-y-8 animate-fadeInUp">
      <div className="text-center">
        <div className="inline-flex items-center gap-2 px-3 py-1 bg-gradient-to-r from-green-500/10 to-emerald-500/10 rounded-full mb-3">
          <i className="fas fa-tag text-green-500 text-xs"></i>
          <span className="text-xs font-semibold text-green-600">출시 기념 50% 할인 진행중</span>
        </div>
        <h2 className="text-2xl lg:text-3xl font-bold text-gray-900">합리적인 가격, 강력한 성과</h2>
        <p className="text-sm text-gray-500 mt-2">MR 1명의 월 교통비보다 저렴한 가격으로<br/>팀 전체의 영업 생산성을 높이세요</p>
      </div>
      <div className="grid grid-cols-1 md:grid-cols-3 gap-5 lg:gap-6 max-w-5xl mx-auto">
        {plans.map((plan, i) => (
          <div key={i} className={`rounded-2xl p-5 lg:p-6 transition-all duration-300 ${
            plan.highlight ? 'bg-gradient-to-b from-primary-800 to-primary-900 text-white shadow-2xl shadow-primary-800/30 md:scale-105 border-2 border-primary-400/30' : 'bg-white border border-surface-200 hover:shadow-lg'
          }`}>
            {plan.highlight && <div className="text-center mb-3"><span className="text-[10px] font-bold px-3 py-1 rounded-full bg-yellow-400 text-primary-900">MOST POPULAR</span></div>}
            <h3 className={`text-lg lg:text-xl font-bold ${plan.highlight?'text-white':'text-gray-900'}`}>{plan.name}</h3>
            <p className={`text-[11px] lg:text-xs mt-1 ${plan.highlight?'text-blue-200':'text-gray-400'}`}>{plan.desc}</p>
            <div className="mt-4 mb-5 lg:mb-6">
              <span className={`text-2xl lg:text-3xl font-black ${plan.highlight?'text-white':'text-gray-900'}`}>{plan.price.startsWith('문의')?'':'₩'}{plan.price}</span>
              <span className={`text-sm ${plan.highlight?'text-blue-200':'text-gray-400'}`}>{plan.period}</span>
            </div>
            <ul className="space-y-2.5 lg:space-y-3 mb-5 lg:mb-6">
              {plan.features.map((f, j) => (
                <li key={j} className={`flex items-center gap-2 text-xs lg:text-sm ${plan.highlight?'text-blue-100':'text-gray-600'}`}>
                  <i className={`fas fa-check text-xs ${plan.highlight?'text-green-300':'text-green-500'}`}></i>{f}
                </li>
              ))}
            </ul>
            <button className={`w-full py-2.5 lg:py-3 rounded-xl font-semibold text-xs lg:text-sm transition-all duration-200 ${
              plan.highlight ? 'bg-white text-primary-800 hover:bg-blue-50 shadow-lg' : 'bg-primary-800 text-white hover:bg-primary-700'
            }`}>{plan.cta}</button>
          </div>
        ))}
      </div>
      <div className="bg-white rounded-2xl p-5 lg:p-6 shadow-sm border border-surface-200/60 max-w-5xl mx-auto">
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 lg:gap-6 text-center">
          {[{icon:'fa-shield-halved',color:'text-green-500',title:'HIPAA 준수',desc:'의료정보 보안 기준 충족'},{icon:'fa-lock',color:'text-blue-500',title:'데이터 암호화',desc:'AES-256 엔드투엔드 암호화'},{icon:'fa-clock',color:'text-purple-500',title:'99.9% 가동률',desc:'SLA 보장 (Enterprise)'},{icon:'fa-headset',color:'text-orange-500',title:'전문 지원',desc:'제약업계 전문 CS팀 운영'}].map((item, i) => (
            <div key={i}>
              <i className={`fas ${item.icon} ${item.color} text-xl lg:text-2xl mb-2`}></i>
              <h4 className="font-bold text-gray-900 text-xs lg:text-sm">{item.title}</h4>
              <p className="text-[10px] lg:text-xs text-gray-400 mt-0.5 lg:mt-1">{item.desc}</p>
            </div>
          ))}
        </div>
      </div>

    </div>
  );
}

// ============================================================
// MAIN APP
// ============================================================
function App() {
  const [currentPage, setCurrentPage] = useState('dashboard');
  const [sidebarOpen, setSidebarOpen] = useState(false);
  const [kolSearchQuery, setKolSearchQuery] = useState('');

  const handleNavigateToKOL = (query) => {
    setKolSearchQuery(query);
    setCurrentPage('kol');
  };

  const renderPage = () => {
    switch (currentPage) {
      case 'dashboard': return <Dashboard onNavigateToKOL={handleNavigateToKOL} />;
      case 'kol': return <KOLIntelligence key={kolSearchQuery} initialQuery={kolSearchQuery} />;
      case 'pnt': return <PnTStrategy />;
      case 'pricing': return <PricingPage />;
      default: return <Dashboard onNavigateToKOL={handleNavigateToKOL} />;
    }
  };
  return (
    <div className="flex min-h-screen bg-surface-50">
      <Sidebar currentPage={currentPage} setCurrentPage={(page) => { setCurrentPage(page); setKolSearchQuery(''); }} sidebarOpen={sidebarOpen} setSidebarOpen={setSidebarOpen} />
      <main className="flex-1 lg:ml-64 min-w-0">
        <Header currentPage={currentPage} setSidebarOpen={setSidebarOpen} />
        <div className="p-4 lg:p-6 xl:p-8">{renderPage()}</div>
      </main>
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
</script>
</body>
</html>
